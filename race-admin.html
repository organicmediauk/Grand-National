<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>EXB Grand National ‚Äî Admin (Original)</title>
<style>
  *{box-sizing:border-box;margin:0;padding:0}
  body{font-family:Arial,sans-serif;background:linear-gradient(135deg,#1e3c72 0%,#2a5298 100%);min-height:100vh;padding:20px}
  .container{max-width:1200px;margin:0 auto;background:#fff;border-radius:20px;padding:30px;box-shadow:0 20px 40px rgba(0,0,0,.1)}
  .header{text-align:center;margin-bottom:30px}
  .header h1{color:#2c3e50;font-size:2.2rem;margin-bottom:8px;text-shadow:2px 2px 4px rgba(0,0,0,.08)}
  .header p{color:#7f8c8d}
  .track-container{background:linear-gradient(to right,#27ae60,#2ecc71);border-radius:15px;padding:30px;margin-bottom:24px;position:relative;overflow:hidden}
  .track-container::before{content:"";position:absolute;inset:0;background:repeating-linear-gradient(90deg,transparent,transparent 48px,rgba(255,255,255,.1) 48px,rgba(255,255,255,.1) 52px);pointer-events:none}
  .finish-line{position:absolute;right:20px;top:0;bottom:0;width:8px;background:repeating-linear-gradient(0deg,#000 0px,#000 10px,#fff 10px,#fff 20px);border-radius:4px}
  .finish-flag{position:absolute;right:10px;top:10px;font-size:2rem}
  .reward-marker{position:absolute;top:10px;background:rgba(255,255,255,.92);border:2px solid #f39c12;border-radius:8px;padding:5px 8px;font-size:.8rem;font-weight:bold;color:#2c3e50;z-index:5;box-shadow:0 2px 4px rgba(0,0,0,.2)}
  .reward-marker.scratch-card{border-color:#e74c3c;background:linear-gradient(45deg,#fff,#ffe6e6)}
  .reward-marker.move-forward{border-color:#3498db;background:linear-gradient(45deg,#fff,#e6f3ff)}
  .reward-marker.extra-lead{border-color:#9b59b6;background:linear-gradient(45deg,#fff,#f3e6ff)}
  .lane{display:flex;align-items:center;margin-bottom:18px;background:rgba(255,255,255,.12);border-radius:10px;padding:15px;position:relative;min-height:80px}
  .lane:last-child{margin-bottom:0}
  .horse{font-size:2.5rem;transition:all .5s ease;position:absolute;left:15px;z-index:10;cursor:pointer}
  .horse:hover{transform:scale(1.06)}
  .salesperson-info{background:rgba(255,255,255,.92);border-radius:8px;padding:10px 15px;margin-left:80px;flex:1;display:flex;justify-content:space-between;align-items:center}
  .salesperson-name{font-weight:bold;color:#2c3e50;font-size:1.05rem}
  .points{background:#3498db;color:#fff;padding:5px 12px;border-radius:20px;font-weight:bold;margin-right:8px}
  .laps{background:#f39c12;color:#fff;padding:3px 8px;border-radius:15px;font-size:.9rem;margin-left:8px}
  .controls{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px;margin-bottom:24px}
  .control-panel{background:#f8f9fa;border-radius:12px;padding:20px;border:2px solid #e9ecef}
  .control-panel h3{color:#2c3e50;margin-bottom:12px;font-size:1.1rem}
  .control-row{display:flex;align-items:center;margin-bottom:10px;gap:10px}
  .control-row label{min-width:110px;font-weight:600;color:#495057}
  .control-row input,.control-row select{flex:1;padding:8px 12px;border:2px solid #dee2e6;border-radius:6px;font-size:1rem}
  .btn{background:#3498db;color:#fff;border:none;padding:10px 16px;border-radius:6px;cursor:pointer;font-size:1rem;font-weight:600}
  .btn:hover{background:#2980b9}
  .btn-danger{background:#e74c3c}.btn-danger:hover{background:#c0392b}
  .btn-success{background:#27ae60}.btn-success:hover{background:#229954}
  .leaderboard{background:#f8f9fa;border-radius:12px;padding:20px;border:2px solid #e9ecef}
  .leaderboard h3{color:#2c3e50;text-align:center;margin-bottom:12px}
  .leaderboard-item{display:flex;justify-content:space-between;align-items:center;padding:10px;margin-bottom:8px;background:#fff;border-radius:8px;border-left:4px solid #3498db}
  .leaderboard-item.first{border-left-color:#f1c40f;background:linear-gradient(90deg,#fff9e6,#fff)}
  .leaderboard-item.second{border-left-color:#95a5a6;background:linear-gradient(90deg,#f8f9fa,#fff)}
  .leaderboard-item.third{border-left-color:#e67e22;background:linear-gradient(90deg,#fdf2f9,#fff)}
  .position{font-weight:bold;color:#2c3e50;min-width:30px}
  .reason-notification{position:fixed;top:20px;right:20px;background:#fff;border:2px solid #3498db;border-radius:10px;padding:15px 20px;font-size:1rem;color:#2c3e50;z-index:1000;box-shadow:0 4px 12px rgba(0,0,0,.15);animation:slideIn .3s ease-out;max-width:320px}
  .reason-notification.penalty{border-color:#e74c3c;background:linear-gradient(45deg,#fff,#ffeaea)}
  .reason-notification.positive{border-color:#27ae60;background:linear-gradient(45deg,#fff,#eafaf1)}
  @keyframes slideIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}
  @keyframes bounce{from{transform:translateY(0)}to{transform:translateY(-10px)}}
  @media(max-width:768px){.container{padding:20px}.horse{font-size:2rem}.salesperson-info{margin-left:60px}}
  table{width:100%;border-collapse:collapse}
  th,td{border:1px solid #e5e7eb;padding:8px;text-align:left;font-size:.95rem}
  th{background:#eef2f7;color:#2c3e50}
  td input, td select{width:100%}
  .muted{opacity:.75}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>üèá EXB Grand National ‚Äî Admin (Original)</h1>
    <p>Full prize set. Changes sync only to the ‚Äúoriginal‚Äù board.</p>
  </div>

  <div class="track-container">
    <div class="finish-line"></div>
    <div class="finish-flag">üèÅ</div>
    <div id="reward-markers"></div>
    <div id="race-lanes"></div>
  </div>

  <div class="controls">
    <div class="control-panel">
      <h3>üë• Manage Players</h3>
      <div class="control-row">
        <label>Add Player</label>
        <input type="text" id="new-player-name" placeholder="Enter player name" />
        <button class="btn btn-success" id="btn-add-player">Add</button>
      </div>
      <div class="control-row">
        <label>Remove</label>
        <select id="remove-player-select"><option value="">Select player</option></select>
        <button class="btn btn-danger" id="btn-remove-player">Remove</button>
      </div>
    </div>

    <div class="control-panel">
      <h3>üéØ Update Points</h3>
      <div class="control-row">
        <label>Player</label>
        <select id="salesperson-select"></select>
      </div>
      <div class="control-row">
        <label>Points</label>
        <input type="number" id="points-input" min="0" max="300" value="0" />
      </div>
      <div class="control-row" style="gap:8px">
        <button class="btn" id="btn-set">Set Points</button>
        <button class="btn" id="btn-add5">+5</button>
        <button class="btn" id="btn-sub5">-5</button>
      </div>
    </div>

    <div class="control-panel">
      <h3>‚ö° Quick Actions</h3>
      <div class="control-row" style="gap:8px">
        <button class="btn btn-success" id="btn-all-plus10">+10 to All</button>
        <button class="btn" id="btn-randomize">Randomize</button>
        <button class="btn" id="btn-reset">Reset Race</button>
      </div>
      <p class="muted" style="margin-top:6px">Tip: click a horse to add +5.</p>
    </div>

    <div class="control-panel" style="grid-column:1/-1">
      <h3>üßÆ Scoring Editor</h3>
      <p class="muted" style="margin-bottom:10px">Edit quick scoring reasons. Use Apply to give points to the selected player.</p>
      <div style="overflow:auto">
        <table id="rules-table">
          <thead>
            <tr>
              <th style="width:42%">Reason</th>
              <th style="width:16%">Points</th>
              <th style="width:18%">Type</th>
              <th style="width:24%">Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="control-row" style="margin-top:10px;gap:8px">
        <button class="btn btn-success" id="btn-add-rule">Add Rule</button>
        <button class="btn" id="btn-save-rules">Save Rules</button>
        <button class="btn" id="btn-publish">Publish Now</button>
      </div>
    </div>
  </div>

  <div class="leaderboard">
    <h3>üèÜ Current Leaderboard</h3>
    <div id="leaderboard-content"></div>
  </div>
</div>

<script>
/* ======= REMOTE SYNC CONFIG (original bucket) ======= */
const ENDPOINT = 'https://script.google.com/macros/s/AKfycbwo5dQQKay--j9Fn-tQwm92q326jgC-wbUYHbHqscouwnQADbP0QrekO1-UHlb7F6yz2Q/exec';
const SECRET  = 'uAnG8Q2vN6!Zr3pX0hJf5wL4cS9tEeB';
const BUCKET  = 'original';
const REMOTE_TIMEOUT = 8000;
/* ================================== */

const TRACK_LENGTH = 30;
const MAX_POINTS = 300;
const MAX_PLAYERS = 15;
const HORSES = ["üêé","üê¥","üèá","ü¶Ñ","üé†"];

/* Full original rewards */
const DEFAULT_REWARDS = [
  { points:3,  type:'scratch-card', name:'Scratch Card',    emoji:'üéüÔ∏è' },
  { points:12, type:'move-forward', name:'Move Forward 2',  emoji:'‚è©'  },
  { points:17, type:'scratch-card', name:'Scratch Card',    emoji:'üéüÔ∏è' },
  { points:23, type:'extra-lead',   name:'Extra Lead',      emoji:'üìû'  },
  { points:27, type:'move-forward', name:'Move Forward 2',  emoji:'‚è©'  },
  { points:30, type:'scratch-card', name:'Scratch Card',    emoji:'üéüÔ∏è' }
];

const DEFAULT_PLAYERS = [
  { name:"Alex Johnson", points:0, horse:"üêé", laps:0 },
  { name:"Sarah Chen", points:0, horse:"üê¥", laps:0 },
  { name:"Mike Rodriguez", points:0, horse:"üèá", laps:0 },
  { name:"Emma Wilson", points:0, horse:"üêé", laps:0 },
  { name:"David Park", points:0, horse:"üê¥", laps:0 }
];
const DEFAULT_RULES = [
  { reason:"Per Open", points:1, type:"positive" },
  { reason:"Per NB Dep taken", points:3, type:"positive" },
  { reason:"3hrs talk time each day", points:3, type:"positive" },
  { reason:"Per Load written", points:3, type:"positive" },
  { reason:"Per settled load", points:5, type:"positive" },
  { reason:"Per settled NB", points:5, type:"positive" },
  { reason:"Most enthusiastic broker", points:5, type:"positive" },
  { reason:"Best dressed broker", points:5, type:"positive" },
  { reason:"Getting 5 RSVPS for VIP", points:5, type:"positive" },
  { reason:"Additional invite over 5", points:1, type:"positive" },
  { reason:"First call close with deposit", points:10, type:"positive" },
  { reason:"Settling 4 NB or loads", points:20, type:"positive" },
  { reason:"Settling ¬£100k Retail", points:20, type:"positive" },
  { reason:"Writing left nuts/Settle", points:20, type:"positive" },
  { reason:"Cancelled deal - Hit Oil Slick", points:-5, type:"penalty" },
  { reason:"Late - Hit a barrier", points:-5, type:"penalty" },
  { reason:"Absent without leave - Puncture", points:-5, type:"penalty" },
  { reason:"Dress code - Stewards Penalty", points:-5, type:"penalty" }
];

let salespeople = DEFAULT_PLAYERS.map(p=>({...p}));
let rules = DEFAULT_RULES.map(r=>({...r}));
let rewards = DEFAULT_REWARDS.map(r=>({...r}));

/* Remote helpers */
async function remoteGetState() {
  const res = await fetch(`${ENDPOINT}?bucket=${encodeURIComponent(BUCKET)}&t=${Date.now()}`, { method: 'GET' });
  const text = await res.text();
  try { return JSON.parse(text); } catch { return { salespeople: [], scoringRules: [], rewards: [], updatedAt: 0 }; }
}
async function remotePostState(state) {
  const controller = new AbortController();
  const id = setTimeout(() => controller.abort(), REMOTE_TIMEOUT);
  const body = JSON.stringify({ ...state, secret: SECRET, bucket: BUCKET });
  const res = await fetch(ENDPOINT, {
    method: 'POST',
    headers: { 'Content-Type': 'text/plain' },
    body,
    signal: controller.signal
  }).catch(err => ({ ok:false, error:String(err) }));
  clearTimeout(id);
  return res && res.ok ? res : { ok:false, error:'HTTP error' };
}
function nowState(){ return { salespeople, scoringRules: rules, rewards }; }
function debounce(fn, ms=600){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; }
const pushRemoteDebounced = debounce(async function(){ try{ await remotePostState(nowState()); }catch(e){} }, 700);

/* DOM helpers */
const $ = s => document.querySelector(s);
const $$ = s => document.querySelectorAll(s);

function renderRewardMarkers(){
  const cont = $("#reward-markers"); cont.innerHTML="";
  const track = $(".track-container"); const w = track.offsetWidth - 100;
  (rewards||[]).forEach(r=>{
    const el=document.createElement("div"); el.className=`reward-marker ${r.type}`;
    el.innerHTML = `${r.emoji} ${r.points}pts<br><small>${r.name}</small>`;
    const pos = 30 + (r.points/TRACK_LENGTH)*(w-60); el.style.left = pos + "px";
    cont.appendChild(el);
  });
}
function renderLanes(){
  const lanes = $("#race-lanes"); lanes.innerHTML="";
  salespeople.forEach((p,i)=>{
    const lane=document.createElement("div"); lane.className="lane"; lane.id=`lane-${i}`;
    lane.innerHTML = `<div class="horse" id="horse-${i}" title="Click to +5">${p.horse}</div>
      <div class="salesperson-info"><span class="salesperson-name">${p.name}</span>
      <div><span class="points">${p.points} pts</span>${p.laps>0?`<span class="laps">Lap ${p.laps}</span>`:""}</div></div>`;
    lanes.appendChild(lane);
  });
  attachHorseClicks();
  salespeople.forEach((_,i)=>{updateHorse(i); updateInfo(i);});
  setTimeout(renderRewardMarkers,100);
}
function attachHorseClicks(){ $$(".horse").forEach((n,i)=>n.addEventListener("click",()=>changePoints(i,+5,"Horse +5"))); }
function updateHorse(i){
  const horse=document.getElementById(`horse-${i}`), lane=document.getElementById(`lane-${i}`); if(!horse||!lane) return;
  const w=lane.offsetWidth-100, finish=40; const lapPos=salespeople[i].points%TRACK_LENGTH;
  const newPos = 15 + (lapPos/TRACK_LENGTH)*(w-finish); horse.style.left=newPos+"px";
  if(lapPos===0 && salespeople[i].points>0){ horse.style.animation="bounce .5s ease-in-out infinite alternate"; setTimeout(()=>{horse.style.animation="none"},1200); }
}
function updateInfo(i){
  const lane=document.getElementById(`lane-${i}`); if(!lane) return; const p=salespeople[i];
  const info=lane.querySelector(".salesperson-info");
  info.innerHTML = `<span class="salesperson-name">${p.name}</span><div><span class="points">${p.points} pts</span>${p.laps>0?`<span class="laps">Lap ${p.laps}</span>`:""}</div>`;
  const badge=info.querySelector(".points");
  if(p.laps>=3) badge.style.background="#27ae60"; else if(p.laps>=1) badge.style.background="#f39c12";
  else if(p.points>=20) badge.style.background="#e67e22"; else badge.style.background="#3498db";
}
function renderLeaderboard(){
  const lb=$("#leaderboard-content"); lb.innerHTML="";
  const sorted=[...salespeople].sort((a,b)=> b.laps - a.laps || b.points - a.points);
  sorted.forEach((p,idx)=>{
    const d=document.createElement("div"); d.className="leaderboard-item";
    if(idx===0 && p.points>0) d.classList.add("first"); else if(idx===1 && p.points>0) d.classList.add("second"); else if(idx===2 && p.points>0) d.classList.add("third");
    const medal=idx===0?"ü•á":idx===1?"ü•à":idx===2?"ü•â":(idx+1)+".";
    d.innerHTML = `<div><span class="position">${medal}</span><span>${p.name}</span>${p.laps>0?`<span class="laps" style="margin-left:8px">L${p.laps}</span>`:""}</div><div><span class="points">${p.points} pts</span></div>`;
    lb.appendChild(d);
  });
}
function refreshDropdowns(){
  const sel=$("#salesperson-select"), rem=$("#remove-player-select"); sel.innerHTML=""; rem.innerHTML='<option value="">Select player</option>';
  salespeople.forEach((p,i)=>{ const a=document.createElement("option"); a.value=i; a.textContent=p.name; sel.appendChild(a);
    const b=document.createElement("option"); b.value=i; b.textContent=p.name; rem.appendChild(b); });
}
function toast(name, delta, reason){
  const n=document.createElement("div"), pos=delta>0; n.className=`reason-notification ${pos?'positive':'penalty'}`;
  n.innerHTML=`${pos?'üéâ':'‚ö†Ô∏è'} <strong>${name}</strong><br>${delta>0?`+${delta}`:delta} points: ${reason}`; document.body.appendChild(n);
  setTimeout(()=>n.remove(),3200);
}

/* Points + rewards (pass OR land) */
function setPoints(i, val, reason="Set"){
  const p=salespeople[i], old=p.points; p.points=Math.max(0,Math.min(MAX_POINTS,val|0)); p.laps=Math.floor(p.points/TRACK_LENGTH);
  checkRewards(i, old, p.points); updateHorse(i); updateInfo(i); renderLeaderboard(); pushRemoteDebounced(); toast(p.name, p.points-old, reason);
}
function changePoints(i, delta, reason="Adjust"){ setPoints(i,(salespeople[i].points||0)+delta,reason); }

function checkRewards(i, oldPts, newPts){
  const player=salespeople[i];
  const oldLap=~~(oldPts/TRACK_LENGTH), newLap=~~(newPts/TRACK_LENGTH);
  const oldPos=oldPts%TRACK_LENGTH, newPos=newPts%TRACK_LENGTH;

  if(newLap>oldLap){ toast(player.name,0,`Completed Lap ${newLap}`); }

  // Rewards fire if the player passes OR lands on a marker within the lap
  (rewards||[]).forEach(r=>{
    const crossed = (oldPos < r.points && newPos >= r.points && newLap === oldLap)  // within same lap
                 || (newLap > oldLap && (oldPos < r.points || newPos >= r.points)); // crossed lap line
    if(crossed){
      toast(player.name,0,`Reward: ${r.emoji} ${r.name}`);
      if(r.type === 'move-forward'){
        setTimeout(()=>setPoints(i, Math.min(MAX_POINTS, player.points+2), "Reward +2"), 800);
      }
      // (Scratch/extra-lead are just notifications in this original; customize if needed)
    }
  });
}

/* Rules table */
function renderRulesTable(){
  const tbody=document.querySelector("#rules-table tbody"); tbody.innerHTML="";
  rules.forEach((rule,i)=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`<td><input type="text" value="${rule.reason}" data-k="reason" /></td>
      <td><input type="number" value="${rule.points}" data-k="points" /></td>
      <td><select data-k="type"><option value="positive"${rule.type==="positive"?" selected":""}>positive</option><option value="penalty"${rule.type==="penalty"?" selected":""}>penalty</option></select></td>
      <td style="display:flex;gap:8px">
        <button class="btn" data-act="apply" data-i="${i}">Apply</button>
        <button class="btn" data-act="dup" data-i="${i}">Duplicate</button>
        <button class="btn btn-danger" data-act="del" data-i="${i}">Delete</button>
      </td>`;
    tbody.appendChild(tr);
  });
  tbody.querySelectorAll("input,select").forEach(el=>{
    el.addEventListener("change",(e)=>{
      const tr=e.target.closest("tr"), idx=[...tbody.children].indexOf(tr), key=e.target.dataset.k;
      let val=e.target.value; if(key==="points") val=parseInt(val||0,10);
      rules[idx]={...rules[idx],[key]:val}; pushRemoteDebounced();
    });
  });
  tbody.querySelectorAll("button").forEach(btn=>{
    btn.addEventListener("click",(e)=>{
      const act=e.target.dataset.act, i=parseInt(e.target.dataset.i,10);
      if(act==="apply"){
        const sel=document.getElementById("salesperson-select"); const idx=parseInt(sel.value,10);
        if(Number.isNaN(idx)) return alert("Select a player first");
        const r=rules[i]; changePoints(idx, parseInt(r.points,10), r.reason);
      } else if(act==="dup"){ rules.splice(i+1,0,{...rules[i]}); renderRulesTable(); pushRemoteDebounced(); }
      else if(act==="del"){ rules.splice(i,1); renderRulesTable(); pushRemoteDebounced(); }
    });
  });
}

/* Buttons */
document.getElementById("btn-add-rule").addEventListener("click",()=>{ rules.push({reason:"New reason", points:1, type:"positive"}); renderRulesTable(); pushRemoteDebounced(); });
document.getElementById("btn-save-rules").addEventListener("click", async ()=>{ await remotePostState(nowState()); alert("Rules saved to server."); });
document.getElementById("btn-publish").addEventListener("click", async ()=>{
  const res=await remotePostState(nowState()); if(res && res.ok) alert("Published to server."); else alert("Publish failed. Check SECRET/URL.");
});
document.getElementById("btn-add-player").addEventListener("click",()=>{
  const name=(document.getElementById("new-player-name").value||"").trim();
  if(!name) return alert("Enter a player name");
  if(salespeople.length>=MAX_PLAYERS) return alert("Max players reached");
  if(salespeople.some(p=>p.name.toLowerCase()===name.toLowerCase())) return alert("Name already exists");
  salespeople.push({ name, points:0, laps:0, horse: HORSES[salespeople.length % HORSES.length] });
  document.getElementById("new-player-name").value="";
  refreshDropdowns(); renderLanes(); renderLeaderboard(); pushRemoteDebounced();
});
document.getElementById("btn-remove-player").addEventListener("click",()=>{
  const idx=parseInt(document.getElementById("remove-player-select").value,10);
  if(Number.isNaN(idx)) return alert("Select a player");
  if(salespeople.length<=1) return alert("Cannot remove last player");
  const name=salespeople[idx].name;
  if(confirm(`Remove ${name}?`)){ salespeople.splice(idx,1); refreshDropdowns(); renderLanes(); renderLeaderboard(); pushRemoteDebounced(); }
});
document.getElementById("btn-set").addEventListener("click",()=>{
  const idx=parseInt(document.getElementById("salesperson-select").value,10);
  if(Number.isNaN(idx)) return alert("Select a player");
  const val=parseInt(document.getElementById("points-input").value,10);
  if(Number.isNaN(val)) return alert("Enter a number");
  setPoints(idx, val, "Manual set");
});
document.getElementById("btn-add5").addEventListener("click",()=>{
  const idx=parseInt(document.getElementById("salesperson-select").value,10);
  if(Number.isNaN(idx)) return alert("Select a player");
  changePoints(idx, +5, "Quick +5");
});
document.getElementById("btn-sub5").addEventListener("click",()=>{
  const idx=parseInt(document.getElementById("salesperson-select").value,10);
  if(Number.isNaN(idx)) return alert("Select a player");
  changePoints(idx, -5, "Quick -5");
});
document.getElementById("btn-all-plus10").addEventListener("click",()=>{ salespeople.forEach((_,i)=>changePoints(i, +10, "All +10")); });
document.getElementById("btn-reset").addEventListener("click",()=>{
  if(!confirm("Reset all to 0")) return;
  salespeople.forEach((p,i)=>{ p.points=0; p.laps=0; updateHorse(i); updateInfo(i); });
  renderLeaderboard(); pushRemoteDebounced();
});
document.getElementById("btn-randomize").addEventListener("click",()=>{
  salespeople.forEach((p,i)=>{ p.points = Math.floor(Math.random()*91); p.laps = Math.floor(p.points/TRACK_LENGTH); updateHorse(i); updateInfo(i); });
  renderLeaderboard(); pushRemoteDebounced();
});

/* Init: load remote; seed ONLY if empty (do NOT auto-overwrite) */
async function init(){
  try{
    const remote = await remoteGetState();
    let seed=false;

    if(remote && Array.isArray(remote.salespeople) && remote.salespeople.length){
      salespeople = remote.salespeople.map(p=>({...p, laps: Math.floor((p.points||0)/TRACK_LENGTH)}));
    } else { seed = true; }

    if(remote && Array.isArray(remote.scoringRules) && remote.scoringRules.length){
      rules = remote.scoringRules;
    } else { seed = true; }

    if(remote && Array.isArray(remote.rewards) && remote.rewards.length){
      rewards = remote.rewards;
    } else { rewards = DEFAULT_REWARDS.map(r=>({...r})); seed = true; }

    if(seed){ await remotePostState(nowState()); } // only seed when empty

  }catch(e){ console.warn("Remote load failed, using defaults.", e); }
  renderLanes(); renderLeaderboard(); refreshDropdowns(); renderRulesTable();
}
window.addEventListener("DOMContentLoaded", init);
</script>
</body>
</html>
